<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Card Battle</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f4f4f4; }
        .view { display: none; }
        .active { display: block; }
        nav { margin-bottom: 20px; background: #333; padding: 10px; border-radius: 5px; }
        nav button { margin-right: 10px; padding: 8px 15px; cursor: pointer; background: #555; color: white; border: none; border-radius: 3px; }
        nav button:hover { background: #777; }
        .card { border: 1px solid #ccc; padding: 15px; margin: 5px; display: inline-block; background: white; border-radius: 5px; width: 180px; vertical-align: top; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
        .log-box { background: #fff; padding: 10px; height: 300px; overflow-y: scroll; border: 1px solid #ccc; margin-top: 10px; font-family: monospace; }
        .stat-box { background: #e8f4ff; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        button.action-btn { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px;}
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="auth-view" class="view active">
        <h1>âš”ï¸ Auto Card Battle</h1>
        <div style="background:white; padding: 20px; border-radius: 5px;">
            <input type="email" id="email" placeholder="ì´ë©”ì¼" style="padding:10px; width:200px;">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:10px; width:200px;">
            <br><br>
            <input type="text" id="username" placeholder="ë‹‰ë„¤ì„ (ê°€ì…ì‹œì—ë§Œ ì…ë ¥)" style="padding:10px; width:200px;">
            <br><br>
            <button class="action-btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="action-btn" style="background-color:#28a745" onclick="handleSignup()">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <nav>
            <button onclick="showView('user-view')">ğŸ‘¤ ë‚´ ì •ë³´</button>
            <button onclick="showView('dungeon-view')">âš”ï¸ ë˜ì „</button>
            <button onclick="showView('inventory-view')">ğŸ’ ì¸ë²¤í† ë¦¬</button>
            <button onclick="showView('chain-view')">ğŸ”— ìŠ¤í‚¬ ì²´ì¸</button>
            <button onclick="logout()" style="float:right; background:#d9534f">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>

        <div id="user-view" class="view active">
            <h2>ë‚´ ì •ë³´</h2>
            <div class="stat-box">
                <p><strong>ë‹‰ë„¤ì„:</strong> <span id="disp-name"></span></p>
                <p><strong>ë ˆë²¨:</strong> <span id="disp-lvl"></span></p>
                <p><strong>HP:</strong> <span id="disp-hp"></span></p>
                <p><strong>EXP:</strong> <span id="disp-exp"></span></p>
                <p><strong>ê³¨ë“œ:</strong> <span id="disp-gold"></span></p>
            </div>
        </div>

        <div id="dungeon-view" class="view">
            <h2>ë˜ì „ ì„ íƒ</h2>
            <button class="action-btn" onclick="startBattle('DUMMY')">í—ˆìˆ˜ì•„ë¹„ (ì—°ìŠµ)</button>
            <button class="action-btn" style="background:#dc3545" onclick="startBattle('INFINITE')">ë¬´í•œì˜ í—ˆìˆ˜ì•„ë¹„</button>
            <h3>ì „íˆ¬ ë¡œê·¸</h3>
            <div id="battle-log" class="log-box">ì „íˆ¬ë¥¼ ì‹œì‘í•˜ë©´ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>

        <div id="inventory-view" class="view">
            <h2>ë³´ìœ  ìŠ¤í‚¬ ëª©ë¡</h2>
            <p>ë³´ìœ í•œ ìŠ¤í‚¬ ì¹´ë“œì…ë‹ˆë‹¤. ì²´ì¸ ë©”ë‰´ì—ì„œ ì¥ì°©í•˜ì„¸ìš”.</p>
            <div id="inventory-list"></div>
        </div>

        <div id="chain-view" class="view">
            <h2>ìŠ¤í‚¬ ì²´ì¸ ì„¤ì •</h2>
            <p>ì „íˆ¬ ì‹œ ìˆœì„œëŒ€ë¡œ ë°œë™ë˜ëŠ” ìŠ¤í‚¬ì…ë‹ˆë‹¤. (0ë²ˆë¶€í„° ì‹œì‘)</p>
            <button class="action-btn" onclick="resetChain()">ì²´ì¸ ì´ˆê¸°í™” (ì „ì²´ í•´ì œ)</button>
            <div id="chain-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
            authDomain: "FIREBASE_AUTH_DOMAIN_PLACEHOLDER",
            projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
            storageBucket: "FIREBASE_STORAGE_BUCKET_PLACEHOLDER",
            messagingSenderId: "FIREBASE_SENDER_ID_PLACEHOLDER",
            appId: "FIREBASE_APP_ID_PLACEHOLDER"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentUid = null;

        // --- Auth Functions ---
        window.handleSignup = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            if(!username) return alert("ê°€ì… ì‹œ ë‹‰ë„¤ì„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const uid = cred.user.uid;
                // ì„œë²„ DB ë“±ë¡
                const res = await fetch('/api/user/signup', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ uid, username })
                });
                if(res.ok) alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
                else {
                    const err = await res.text();
                    alert("ì˜¤ë¥˜: " + err);
                }
            } catch(e) { alert(e.message); }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
                currentUid = cred.user.uid;
                await loadUserData();
                document.getElementById('auth-view').classList.remove('active');
                document.getElementById('game-container').classList.remove('hidden');
            } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        // --- Game Logic ---
        window.showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'inventory-view' || id === 'chain-view') loadChainAndInventory();
        };

        async function loadUserData() {
            if(!currentUid) return;
            const res = await fetch(`/api/user/login?uid=${currentUid}`);
            const user = await res.json();
            
            document.getElementById('disp-name').innerText = user.username;
            document.getElementById('disp-lvl').innerText = user.level;
            document.getElementById('disp-hp').innerText = user.maxHp;
            document.getElementById('disp-exp').innerText = user.exp;
            document.getElementById('disp-gold').innerText = user.gold;
        }

        async function loadChainAndInventory() {
            // ì¸ë²¤í† ë¦¬ ì¡°íšŒ
            const invRes = await fetch(`/api/chain/inventory?uid=${currentUid}`);
            const inventory = await invRes.json();
            
            // ì²´ì¸ ì¡°íšŒ
            const chainRes = await fetch(`/api/chain/list?uid=${currentUid}`);
            const chain = await chainRes.json();

            // ì¸ë²¤í† ë¦¬ ë Œë”ë§
            const invDiv = document.getElementById('inventory-list');
            invDiv.innerHTML = inventory.map(item => `
                <div class="card">
                    <h3>${item.skillName}</h3>
                    <p>ìˆ˜ëŸ‰: ${item.quantity}</p>
                    <button class="action-btn" onclick="equipSkill('${item.skillName}')">ì²´ì¸ì— ì¶”ê°€</button>
                </div>
            `).join('');

            // ì²´ì¸ ë Œë”ë§
            const chainDiv = document.getElementById('chain-list');
            chainDiv.innerHTML = chain.map(c => `
                <div class="card" style="border-color: #007bff;">
                    <h3>[${c.chainOrder}] ${c.skillName}</h3>
                    <p>ì¿¨íƒ€ì„: ${c.cooldown}s</p>
                    <p>íš¨ê³¼: ${c.effectType} ${c.effectValue}</p>
                </div>
            `).join('');
        }

        window.equipSkill = async (skillName) => {
            const res = await fetch(`/api/chain/equip`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid: currentUid, skillName: skillName })
            });
            if(res.ok) {
                alert("ì¥ì°© ì™„ë£Œ!");
                loadChainAndInventory();
            } else {
                alert("ì¥ì°© ì‹¤íŒ¨ (ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼ ë“±)");
            }
        };

        window.resetChain = async () => {
            if(!confirm("ì²´ì¸ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`/api/chain/reset?uid=${currentUid}`, { method: 'POST' });
            loadChainAndInventory();
        };

        window.startBattle = async (type) => {
            document.getElementById('battle-log').innerText = "ì „íˆ¬ ê³„ì‚° ì¤‘...";
            const res = await fetch(`/api/battle/start?uid=${currentUid}&monsterType=${type}`);
            const data = await res.json();
            
            const logDiv = document.getElementById('battle-log');
            logDiv.innerHTML = `<h4>ê²°ê³¼: ${data.result}</h4>` + data.logs.join('<br>');
            loadUserData(); // ì „íˆ¬ í›„ ë³´ìƒ ë°˜ì˜ í™•ì¸
        };
    </script>
</body>
</html>
