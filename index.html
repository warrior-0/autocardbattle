<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Card Battle</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f4f4f4; line-height: 1.6; }
        .view { display: none; }
        .active { display: block; }
        nav { margin-bottom: 20px; background: #333; padding: 10px; border-radius: 8px; display: flex; gap: 10px; flex-wrap: wrap; }
        nav button { padding: 8px 15px; cursor: pointer; background: #555; color: white; border: none; border-radius: 5px; transition: 0.3s; }
        nav button:hover { background: #777; }
        .card { border: 1px solid #ccc; padding: 15px; margin: 5px; display: inline-block; background: white; border-radius: 8px; width: 180px; vertical-align: top; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); }
        .log-box { background: #1e1e1e; color: #00ff00; padding: 15px; height: 350px; overflow-y: auto; border-radius: 8px; margin-top: 10px; font-family: 'Courier New', monospace; border: 2px solid #444; }
        .stat-box { background: #e8f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b3d7ff; }
        button.action-btn { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-top: 5px; font-weight: bold; }
        button.action-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        h1, h2 { color: #333; }
    </style>
</head>
<body>

    <div id="auth-view" class="view active">
        <h1>âš”ï¸ Auto Card Battle</h1>
        <div style="background:white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h3>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
            <input type="email" id="email" placeholder="ì´ë©”ì¼" style="padding:12px; width:250px; margin-bottom:10px; border-radius:5px; border:1px solid #ddd;"><br>
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:12px; width:250px; margin-bottom:10px; border-radius:5px; border:1px solid #ddd;"><br>
            <input type="text" id="username" placeholder="ë‹‰ë„¤ì„ (ê°€ì… ì‹œ í•„ìˆ˜)" style="padding:12px; width:250px; margin-bottom:15px; border-radius:5px; border:1px solid #ddd;"><br>
            <button class="action-btn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <button class="action-btn" style="background-color:#28a745" onclick="handleSignup()">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="game-container" class="hidden">
        <nav>
            <button onclick="showView('user-view')">ğŸ‘¤ ë‚´ ì •ë³´</button>
            <button onclick="showView('dungeon-view')">âš”ï¸ ë˜ì „</button>
            <button onclick="showView('inventory-view')">ğŸ’ ì¸ë²¤í† ë¦¬</button>
            <button onclick="showView('chain-view')">ğŸ”— ìŠ¤í‚¬ ì²´ì¸</button>
            <button onclick="logout()" style="margin-left:auto; background:#d9534f">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>

        <div id="user-view" class="view">
            <h2>ë‚´ í”„ë¡œí•„</h2>
            <div class="stat-box">
                <p><strong>ë‹‰ë„¤ì„:</strong> <span id="disp-name">-</span></p>
                <p><strong>ë ˆë²¨:</strong> <span id="disp-lvl">1</span></p>
                <p><strong>HP:</strong> <span id="disp-hp">100</span></p>
                <p><strong>EXP:</strong> <span id="disp-exp">0</span></p>
                <p><strong>ê³¨ë“œ:</strong> <span id="disp-gold">0</span></p>
            </div>
        </div>

        <div id="dungeon-view" class="view">
            <h2>ë˜ì „ ì„ íƒ</h2>
            <button class="action-btn" id="btn-dummy" onclick="startBattle('DUMMY')">í›ˆë ¨ìš© í—ˆìˆ˜ì•„ë¹„</button>
            <button class="action-btn" id="btn-infinite" style="background:#dc3545" onclick="startBattle('INFINITE')">ë¬´í•œì˜ í—ˆìˆ˜ì•„ë¹„</button>
            <h3>ì „íˆ¬ ë¡œê·¸</h3>
            <div id="battle-log" class="log-box">ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div id="inventory-view" class="view">
            <h2>ğŸ’ ë³´ìœ  ìŠ¤í‚¬</h2>
            <div id="inventory-list"></div>
        </div>

        <div id="chain-view" class="view">
            <h2>ğŸ”— ìŠ¤í‚¬ ì²´ì¸ ì„¤ì •</h2>
            <button class="action-btn" style="background:#6c757d" onclick="resetChain()">ì²´ì¸ ì´ˆê¸°í™”</button>
            <div id="chain-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- 1. ì„¤ì • ë° ê¸€ë¡œë²Œ ë³€ìˆ˜ ---
        const API_BASE_URL = "https://autocardbattle.onrender.com";
        let auth = null;
        let currentUid = null;
        let isSigningUp = false; // ê°€ì… ì¤‘ ìë™ ì´ë™ ë°©ì§€ í”Œë˜ê·¸

        // --- 2. ì´ˆê¸°í™” í•¨ìˆ˜ ---
        async function initGame() {
            try {
                const configRes = await fetch(`${API_BASE_URL}/api/config/firebase`);
                if (!configRes.ok) throw new Error("ì„¤ì • ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                
                const firebaseConfig = await configRes.json();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    // ê°€ì… ì ˆì°¨ ì¤‘ì´ ì•„ë‹ ë•Œë§Œ ìœ ì € ê°ì§€ ì‹œ ìë™ ë¡œê·¸ì¸ ì²˜ë¦¬
                    if (user && !isSigningUp) {
                        currentUid = user.uid;
                        loadUserData();
                        enterGameUI();
                    }
                });
            } catch (error) {
                console.error("ì´ˆê¸°í™” ì—ëŸ¬:", error);
                alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        initGame();

        // ê²Œì„ í™”ë©´ìœ¼ë¡œ UI ì „í™˜í•˜ëŠ” í•¨ìˆ˜
        function enterGameUI() {
            document.getElementById('auth-view').classList.remove('active');
            document.getElementById('game-container').classList.remove('hidden');
            showView('user-view');
        }

        // --- 3. íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•¨ìˆ˜ ---
        window.handleSignup = async () => {
            if (!auth) return alert("Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤...");
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            if(!username) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            isSigningUp = true; // ê°€ì… ì‹œì‘ì 

            try {
                // 1. Firebase Auth ê³„ì • ìƒì„±
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                
                // 2. ë°±ì—”ë“œ ì„œë²„ì— ìœ ì € ë° ê¸°ë³¸ ìŠ¤í‚¬ ì €ì¥
                const res = await fetch(`${API_BASE_URL}/api/user/signup`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        firebaseUid: cred.user.uid, // ì„œë²„ ì—”í‹°í‹° í•„ë“œëª…ì— ë§ì¶¤
                        username: username 
                    })
                });

                if(res.ok) {
                    alert("ê°€ì… ì„±ê³µ! í™•ì¸ì„ ëˆ„ë¥´ë©´ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
                    isSigningUp = false; // í”Œë˜ê·¸ í•´ì œ
                    currentUid = cred.user.uid;
                    loadUserData();
                    enterGameUI();
                } else {
                    const errData = await res.json();
                    throw new Error(errData.message || "ì„œë²„ ì €ì¥ ì‹¤íŒ¨");
                }
            } catch(e) { 
                isSigningUp = false; 
                alert("ê°€ì… ì‹¤íŒ¨: " + e.message); 
            }
        };

        window.handleLogin = async () => {
            if (!auth) return alert("Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤...");
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }
        };

        window.logout = () => { signOut(auth).then(() => location.reload()); };

        // --- 4. ê²Œì„ ë¡œì§ í•¨ìˆ˜ë“¤ ---
        window.showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'inventory-view' || id === 'chain-view') loadChainAndInventory();
        };

        async function loadUserData() {
            if(!currentUid) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/user/login?uid=${currentUid}`);
                if(!res.ok) return;
                const user = await res.json();
                document.getElementById('disp-name').innerText = user.username;
                document.getElementById('disp-lvl').innerText = user.level;
                document.getElementById('disp-hp').innerText = user.maxHp;
                document.getElementById('disp-exp').innerText = user.exp;
                document.getElementById('disp-gold').innerText = user.gold;
            } catch(e) { console.error("ìœ ì € ë¡œë“œ ì‹¤íŒ¨", e); }
        }
        
        // ì²´ì¸ ë° ì¸ë²¤í† ë¦¬ ë¡œë“œ í•¨ìˆ˜
        async function loadChainAndInventory() {
            if(!currentUid) return;
            try {
                const [invRes, chainRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/chain/inventory?uid=${currentUid}`),
                    fetch(`${API_BASE_URL}/api/chain/list?uid=${currentUid}`)
                ]);
        
                const inventory = invRes.ok ? await invRes.json() : [];
                const chain = chainRes.ok ? await chainRes.json() : [];
        
                // [ìˆ˜ì •] ì¸ë²¤í† ë¦¬: ì¥ì°©í•˜ê¸° ë²„íŠ¼ ì œê±°, ë³´ìœ  ìˆ˜ë§Œ í‘œì‹œ
                document.getElementById('inventory-list').innerHTML = inventory.length > 0 
                    ? inventory.map(item => `
                        <div class="card" style="cursor: pointer;" onclick="equipSkill('${item.skillName}')" title="í´ë¦­í•˜ë©´ ì²´ì¸ì— ì¶”ê°€ë©ë‹ˆë‹¤">
                            <h3>${item.skillName}</h3>
                            <p>ë³´ìœ ìˆ˜: ${item.quantity}ê°œ</p>
                            <small style="color:#007bff">í´ë¦­í•˜ì—¬ ì¥ì°©</small>
                        </div>`).join('')
                    : "<p>ë³´ìœ í•œ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        
                // [ìˆ˜ì •] ì²´ì¸ ë¦¬ìŠ¤íŠ¸: í•´ì œ ë²„íŠ¼ ì¶”ê°€
                document.getElementById('chain-list').innerHTML = chain.length > 0
                    ? chain.map(c => `
                        <div class="card" style="border-color: #007bff;">
                            <div style="display:flex; justify-content:space-between;">
                                <span style="font-weight:bold; color:#007bff;">#${c.chainOrder + 1}</span>
                                <button onclick="unequipSkill(${c.id})" style="border:none; background:none; color:red; cursor:pointer;">âœ–</button>
                            </div>
                            <h3>${c.skillName}</h3>
                            <p>âš¡ ${c.cooldown}s | âš”ï¸ ${c.effectValue}</p>
                        </div>`).join('')
                    : "<p>ì¥ì°©ëœ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤. ì¸ë²¤í† ë¦¬ì˜ ìŠ¤í‚¬ì„ í´ë¦­í•˜ì„¸ìš”.</p>";
        
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", e);
            }
        }
        
        // [ì¶”ê°€] ìŠ¤í‚¬ í•´ì œ í•¨ìˆ˜ (ì²´ì¸ì—ì„œ ì‚­ì œ)
        window.unequipSkill = async (chainId) => {
            if(!confirm("ì´ ìŠ¤í‚¬ì„ ì²´ì¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/chain/unequip?id=${chainId}`, {
                    method: 'DELETE'
                });
                if(res.ok) {
                    loadChainAndInventory(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert("í•´ì œ ì‹¤íŒ¨!");
                }
            } catch(e) {
                console.error("í•´ì œ ì¤‘ ì˜¤ë¥˜:", e);
            }
        };
        window.equipSkill = async (skillName) => {
            const res = await fetch(`${API_BASE_URL}/api/chain/equip`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid: currentUid, skillName })
            });
            if(res.ok) { loadChainAndInventory(); }
            else { alert("ì¥ì°© ì‹¤íŒ¨!"); }
        };

        window.resetChain = async () => {
            if(!confirm("ì²´ì¸ì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${API_BASE_URL}/api/chain/reset?uid=${currentUid}`, { method: 'POST' });
            loadChainAndInventory();
        };

        window.startBattle = async (type) => {
            const logDiv = document.getElementById('battle-log');
            const btns = [document.getElementById('btn-dummy'), document.getElementById('btn-infinite')];
            btns.forEach(b => b.disabled = true);
            logDiv.innerHTML = "âš”ï¸ <strong>ì „íˆ¬ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</strong>";
        
            try {
                const res = await fetch(`${API_BASE_URL}/api/battle/start?uid=${currentUid}&monsterType=${type}`);
                const data = await res.json();
                logDiv.innerHTML = "âš”ï¸ <strong>ì „íˆ¬ ì‹œì‘!</strong><br><br>";

                const groupedLogs = {};
                const otherLogs = [];

                data.logs.forEach(log => {
                    const match = log.match(/\[T(\d+)\]/);
                    if (match) {
                        const tick = match[0];
                        if (!groupedLogs[tick]) groupedLogs[tick] = [];
                        groupedLogs[tick].push(log);
                    } else {
                        otherLogs.push(log);
                    }
                });

                const ticks = Object.keys(groupedLogs).sort((a, b) => parseInt(a.replace(/\D/g, '')) - parseInt(b.replace(/\D/g, '')));
                const startMessages = otherLogs.filter(msg => !msg.includes("ìŠ¹ë¦¬") && !msg.includes("íŒ¨ë°°") && !msg.includes("ë¬´ìŠ¹ë¶€"));
                startMessages.forEach(msg => logDiv.innerHTML += `> ${msg}<br>`);

                let tickIdx = 0;
                const interval = setInterval(() => {
                    if (tickIdx < ticks.length) {
                        const tickLogs = groupedLogs[ticks[tickIdx]];
                        tickLogs.forEach(msg => { logDiv.innerHTML += `> ${msg}<br>`; });
                        logDiv.scrollTop = logDiv.scrollHeight;
                        tickIdx++;
                    } else {
                        clearInterval(interval);
                        const endMessages = otherLogs.filter(msg => msg.includes("ìŠ¹ë¦¬") || msg.includes("íŒ¨ë°°") || msg.includes("ë¬´ìŠ¹ë¶€"));
                        endMessages.forEach(msg => logDiv.innerHTML += `<br><strong>${msg}</strong><br>`);
                        const color = data.result === "WIN" ? "#28a745" : "#dc3545";
                        logDiv.innerHTML += `<br><strong style="color:${color}; font-size:1.2em;">[ìµœì¢… ê²°ê³¼: ${data.result}]</strong><br>`;
                        btns.forEach(b => b.disabled = false);
                        loadUserData();
                    }
                }, 1000);
            } catch(e) {
                logDiv.innerHTML = "âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                btns.forEach(b => b.disabled = false);
            }
        };
    </script>
</body>
</html>
